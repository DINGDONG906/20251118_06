<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è‡ªå‹•ç”Ÿæˆå¡«å­—éŠæˆ²</title>
    <style>
        body {
            font-family: "å¾®è»Ÿæ­£é»‘é«”", sans-serif;
            background-color: #f8f9fa;
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 0;
            padding: 20px;
        }

        h1 { color: #2c3e50; margin-bottom: 10px; }
        .sub-text { color: #7f8c8d; font-size: 0.9em; margin-bottom: 20px; }

        /* éŠæˆ²ä¸»å€åŸŸ */
        .game-wrapper {
            display: flex;
            gap: 40px;
            align-items: flex-start;
            flex-wrap: wrap;
            justify-content: center;
            max-width: 1200px;
        }

        /* å¡«å­—ç¶²æ ¼å€ */
        #crossword-board {
            display: grid;
            /* æ ¼å­å¤§å°ç”± JS å‹•æ…‹è¨­å®šï¼Œä½†é€™è£¡è¨­å€‹é è¨­å€¼ */
            background: #2c3e50;
            padding: 5px;
            border: 2px solid #2c3e50;
            gap: 1px; /* æ ¼å­é–“çš„é»‘ç·š */
        }

        .cell {
            width: 40px;
            height: 40px;
            background-color: #2c3e50; /* é è¨­æ˜¯é»‘æ ¼å­ */
            position: relative;
        }

        .cell.active {
            background-color: white;
        }

        /* å„²å­˜æ ¼å…§çš„è¼¸å…¥æ¡† */
        .cell input {
            width: 100%;
            height: 100%;
            border: none;
            text-align: center;
            font-size: 1.2em;
            font-family: "å¾®è»Ÿæ­£é»‘é«”";
            font-weight: bold;
            background: transparent;
            outline: none;
            padding: 0;
            color: #2c3e50;
            cursor: text;
        }
        
        .cell input:focus {
            background-color: #e8f6f3;
        }

        /* é¡Œè™Ÿ (å·¦ä¸Šè§’å°æ•¸å­—) */
        .cell-number {
            position: absolute;
            top: 1px;
            left: 2px;
            font-size: 10px;
            color: #666;
            pointer-events: none;
            font-weight: bold;
        }

        /* æç¤ºå€ */
        .clues-container {
            display: flex;
            gap: 30px;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            min-width: 300px;
        }

        .clue-column {
            flex: 1;
            min-width: 150px;
        }

        h3 { 
            border-bottom: 2px solid #eee; 
            padding-bottom: 10px; 
            color: #2980b9;
        }

        ul { padding-left: 20px; margin: 0; }
        li { margin-bottom: 8px; color: #555; line-height: 1.4;}
        
        /* ç­”å°/ç­”éŒ¯æ¨£å¼ */
        .correct { background-color: #d4efdf !important; }
        .wrong { background-color: #fadbd8 !important; }

        /* æŒ‰éˆ•å€ */
        .controls {
            margin-top: 30px;
            display: flex;
            gap: 15px;
        }

        button {
            padding: 10px 25px;
            font-size: 1em;
            cursor: pointer;
            border: none;
            border-radius: 5px;
            color: white;
            transition: opacity 0.2s;
        }
        
        .btn-check { background-color: #27ae60; }
        .btn-retry { background-color: #3498db; }
        .btn-reveal { background-color: #e67e22; }

        button:hover { opacity: 0.9; }

        /* æ‰‹æ©Ÿèª¿æ•´ */
        @media (max-width: 768px) {
            .cell { width: 32px; height: 32px; }
            .game-wrapper { flex-direction: column-reverse; align-items: center; }
            .clues-container { width: 90%; flex-direction: column; gap: 10px;}
        }
    </style>
</head>
<body>

    <h1>ç”Ÿè©å¡«å­—éŠæˆ²</h1>
    <div class="sub-text">è¼¸å…¥ä¸­æ–‡å®Œæˆå¡«å­—ï¼Œæ ¹æ“šè‹±æ–‡æç¤ºä½œç­”</div>

    <div class="game-wrapper">
        <div class="clues-container">
            <div class="clue-column">
                <h3>æ©«å‘ (Across)</h3>
                <ul id="across-list"></ul>
            </div>
            <div class="clue-column">
                <h3>ç›´å‘ (Down)</h3>
                <ul id="down-list"></ul>
            </div>
        </div>

        <div id="crossword-board"></div>
    </div>

    <div class="controls">
        <button class="btn-check" onclick="checkAnswers()">æª¢æŸ¥ç­”æ¡ˆ</button>
        <button class="btn-reveal" onclick="revealAnswers()">å·çœ‹ç­”æ¡ˆ</button>
        <button class="btn-retry" onclick="initGame()">é‡æ–°ç”Ÿæˆ</button>
    </div>

    <script src="words.js"></script>

    <script>
        const BOARD_SIZE = 15; // ç¶²æ ¼å¤§å° 15x15
        let grid = [];        // å­˜æ”¾è§£ç­”å­—ç¬¦
        let cellInputs = [];  // å­˜æ”¾ DOM å…ƒç´ 
        let activeWords = []; // æˆåŠŸæ”¾é€²å»çš„å­—

        const boardEl = document.getElementById('crossword-board');
        const acrossListEl = document.getElementById('across-list');
        const downListEl = document.getElementById('down-list');

        if (typeof wordData === 'undefined') {
            alert("æ‰¾ä¸åˆ° words.js");
        }

        // åˆå§‹åŒ–
        function initGame() {
            // 1. æ¸…ç©º
            grid = Array(BOARD_SIZE).fill(null).map(() => Array(BOARD_SIZE).fill(null));
            activeWords = [];
            boardEl.innerHTML = '';
            acrossListEl.innerHTML = '';
            downListEl.innerHTML = '';

            // 2. å˜—è©¦ç”Ÿæˆä½ˆå±€
            generateLayout();

            // 3. ç¹ªè£½ç¶²æ ¼
            drawBoard();

            // 4. é¡¯ç¤ºæç¤º
            renderClues();
        }

        // --- æ ¸å¿ƒæ¼”ç®—æ³•ï¼šç”Ÿæˆå¡«å­—ä½ˆå±€ ---
        function generateLayout() {
            // è¤‡è£½ä¸¦æ ¹æ“šé•·åº¦æ’åº (é•·çš„å­—å…ˆæ”¾æ¯”è¼ƒå®¹æ˜“æˆåŠŸ)
            let words = JSON.parse(JSON.stringify(wordData));
            words.sort((a, b) => b.word.length - a.word.length);

            // æ”¾ç½®ç¬¬ä¸€å€‹å­—åœ¨æ­£ä¸­é–“
            if (words.length > 0) {
                let first = words[0];
                let startRow = Math.floor(BOARD_SIZE / 2);
                let startCol = Math.floor((BOARD_SIZE - first.word.length) / 2);
                placeWord(first, startRow, startCol, 'across');
                // æ¨™è¨˜ç‚ºå·²ä½¿ç”¨
                words.shift();
            }

            // å˜—è©¦æ”¾ç½®å…¶é¤˜çš„å­—
            // é‡è¤‡æƒæå¹¾æ¬¡åˆ—è¡¨ï¼Œå› ç‚ºå¾Œé¢åŠ é€²ä¾†çš„å­—å¯èƒ½æœƒå‰µé€ æ–°çš„é€£æ¥é»
            for (let pass = 0; pass < 2; pass++) {
                for (let i = 0; i < words.length; i++) {
                    let currentWordObj = words[i];
                    if (currentWordObj.isPlaced) continue;

                    // å˜—è©¦å°‹æ‰¾äº¤å‰é»
                    let bestPos = findBestPosition(currentWordObj.word);
                    
                    if (bestPos) {
                        placeWord(currentWordObj, bestPos.row, bestPos.col, bestPos.dir);
                        currentWordObj.isPlaced = true;
                    }
                }
            }
        }

        // å°‹æ‰¾æœ€ä½³æ”¾ç½®ä½ç½®
        function findBestPosition(word) {
            // éæ­·ç¶²æ ¼ä¸Šå·²æœ‰çš„æ¯ä¸€å€‹å­—
            for (let r = 0; r < BOARD_SIZE; r++) {
                for (let c = 0; c < BOARD_SIZE; c++) {
                    if (grid[r][c]) {
                        // å¦‚æœç¶²æ ¼ä¸Šæœ‰å­—ï¼Œæª¢æŸ¥æ–°å–®å­—æ˜¯å¦æœ‰é€™å€‹å­—å…ƒ
                        let charOnGrid = grid[r][c].char;
                        
                        for (let i = 0; i < word.length; i++) {
                            if (word[i] === charOnGrid) {
                                // æ‰¾åˆ°å…±åŒå­—å…ƒï¼
                                // å˜—è©¦å…©å€‹æ–¹å‘ï¼šå¦‚æœåŸå­—æ˜¯æ©«çš„ï¼Œæ–°å­—å°±è©¦ç›´çš„ï¼Œåä¹‹äº¦ç„¶
                                // é€™è£¡æˆ‘å€‘ç°¡åŒ–æª¢æŸ¥ï¼šå˜—è©¦ ç›´å‘æ”¾ç½®
                                if (canPlace(word, r - i, c, 'down')) {
                                    return { row: r - i, col: c, dir: 'down' };
                                }
                                // å˜—è©¦ æ©«å‘æ”¾ç½®
                                if (canPlace(word, r, c - i, 'across')) {
                                    return { row: r, col: c - i, dir: 'across' };
                                }
                            }
                        }
                    }
                }
            }
            return null;
        }

        // æª¢æŸ¥æ˜¯å¦å¯ä»¥æ”¾ç½® (é‚Šç•Œæª¢æŸ¥ + ç¢°æ’æª¢æŸ¥)
        function canPlace(word, row, col, dir) {
            if (row < 0 || col < 0) return false;
            if (dir === 'across') {
                if (col + word.length > BOARD_SIZE) return false;
                // æª¢æŸ¥å·¦é‚Šå’Œå³é‚Šæ˜¯å¦ç·Šé„°å…¶ä»–å­—
                if (col > 0 && grid[row][col-1]) return false;
                if (col + word.length < BOARD_SIZE && grid[row][col+word.length]) return false;
            } else {
                if (row + word.length > BOARD_SIZE) return false;
                // æª¢æŸ¥ä¸Šé‚Šå’Œä¸‹é‚Š
                if (row > 0 && grid[row-1][col]) return false;
                if (row + word.length < BOARD_SIZE && grid[row+word.length][col]) return false;
            }

            for (let i = 0; i < word.length; i++) {
                let r = row + (dir === 'down' ? i : 0);
                let c = col + (dir === 'across' ? i : 0);

                // å¦‚æœè©²æ ¼å·²ç¶“æœ‰å­—ï¼Œå¿…é ˆæ˜¯ç›¸åŒçš„å­— (äº¤å‰é»)
                if (grid[r][c]) {
                    if (grid[r][c].char !== word[i]) return false;
                } else {
                    // å¦‚æœè©²æ ¼æ˜¯ç©ºçš„ï¼Œæª¢æŸ¥å®ƒçš„ã€Œå…©å´ã€æ˜¯å¦æœ‰å­— (é¿å…å…©è¡Œå­—ç·Šè²¼åœ¨ä¸€èµ·)
                    // é€™æ¨£æœƒé€ æˆç„¡æ³•åˆ¤æ–·å–®å­—
                    if (dir === 'across') {
                        if ((r > 0 && grid[r-1][c]) || (r < BOARD_SIZE-1 && grid[r+1][c])) return false;
                    } else {
                        if ((c > 0 && grid[r][c-1]) || (c < BOARD_SIZE-1 && grid[r][c+1])) return false;
                    }
                }
            }
            return true;
        }

        // å°‡å–®å­—å¯«å…¥è³‡æ–™çµæ§‹
        function placeWord(wordObj, row, col, dir) {
            activeWords.push({
                ...wordObj,
                row: row,
                col: col,
                dir: dir,
                number: 0 // ç¨å¾Œè¨ˆç®—
            });

            for (let i = 0; i < wordObj.word.length; i++) {
                let r = row + (dir === 'down' ? i : 0);
                let c = col + (dir === 'across' ? i : 0);
                grid[r][c] = { char: wordObj.word[i] };
            }
        }

        // --- ç¹ªåœ–èˆ‡æ¸²æŸ“ ---
        function drawBoard() {
            // è¨­å®š CSS Grid æ¬„ä½æ•¸
            boardEl.style.gridTemplateColumns = `repeat(${BOARD_SIZE}, 1fr)`;

            // é‡æ–°è¨ˆç®—é¡Œè™Ÿ (ç”±å·¦è‡³å³ï¼Œç”±ä¸Šè‡³ä¸‹)
            // å¦‚æœæŸæ ¼æ˜¯å–®å­—çš„é–‹é ­ï¼Œå°±éœ€è¦æ¨™è™Ÿ
            let numberCounter = 1;
            // å…ˆå°‡ activeWords æ’åºï¼Œç¢ºä¿ç·¨è™Ÿé †åºè‡ªç„¶
            activeWords.sort((a, b) => (a.row * BOARD_SIZE + a.col) - (b.row * BOARD_SIZE + b.col));

            // è™•ç†é‡è¤‡ç·¨è™Ÿ (è‹¥ä¸€å€‹æ ¼å­åŒæ™‚æ˜¯æ©«å‘å’Œç›´å‘çš„é–‹é ­ï¼Œç”¨åŒä¸€å€‹è™Ÿç¢¼)
            let cellNumbers = {}; // key: "r,c", value: number

            activeWords.forEach(w => {
                let key = `${w.row},${w.col}`;
                if (!cellNumbers[key]) {
                    cellNumbers[key] = numberCounter++;
                }
                w.number = cellNumbers[key];
            });

            // ç”Ÿæˆ DOM
            for (let r = 0; r < BOARD_SIZE; r++) {
                for (let c = 0; c < BOARD_SIZE; c++) {
                    let cell = document.createElement('div');
                    cell.className = 'cell';
                    cell.dataset.r = r;
                    cell.dataset.c = c;

                    if (grid[r][c]) {
                        cell.classList.add('active');
                        
                        // 1. æª¢æŸ¥æ˜¯å¦æœ‰é¡Œè™Ÿ
                        let key = `${r},${c}`;
                        if (cellNumbers[key]) {
                            let numSpan = document.createElement('span');
                            numSpan.className = 'cell-number';
                            numSpan.textContent = cellNumbers[key];
                            cell.appendChild(numSpan);
                        }

                        // 2. åŠ å…¥è¼¸å…¥æ¡†
                        let input = document.createElement('input');
                        input.maxLength = 1;
                        input.dataset.answer = grid[r][c].char; // å·å·å­˜ç­”æ¡ˆæ–¹ä¾¿æª¢æŸ¥
                        
                        // è‡ªå‹•è·³ä¸‹ä¸€æ ¼é‚è¼¯ (ç°¡å–®ç‰ˆ)
                        input.oninput = function() {
                            if (this.value) this.classList.remove('wrong', 'correct');
                        };
                        
                        cell.appendChild(input);
                    }
                    boardEl.appendChild(cell);
                }
            }
        }

        function renderClues() {
            activeWords.forEach(w => {
                let li = document.createElement('li');
                // æ ¼å¼: "1. Hello"
                li.innerHTML = `<strong>${w.number}.</strong> ${w.meaning}`;
                
                if (w.dir === 'across') {
                    acrossListEl.appendChild(li);
                } else {
                    downListEl.appendChild(li);
                }
            });

            if (activeWords.length === 0) {
                alert("ç„¡æ³•ç”Ÿæˆå¡«å­—éŠæˆ²ï¼å¯èƒ½æ˜¯å–®å­—ä¹‹é–“æ²’æœ‰å…±åŒå­—å…ƒï¼Œè«‹å˜—è©¦å¢åŠ æ›´å¤šå–®å­—ã€‚");
            }
        }

        // --- åŠŸèƒ½æŒ‰éˆ• ---
        function checkAnswers() {
            let inputs = document.querySelectorAll('.cell input');
            let allCorrect = true;

            inputs.forEach(input => {
                let userVal = input.value.trim();
                let answer = input.dataset.answer;

                if (userVal === answer) {
                    input.classList.add('correct');
                    input.classList.remove('wrong');
                } else {
                    input.classList.add('wrong');
                    input.classList.remove('correct');
                    allCorrect = false;
                }
            });

            if (allCorrect && inputs.length > 0) {
                setTimeout(() => alert("æ­å–œï¼å…¨å°ï¼ğŸ‰"), 100);
            }
        }

        function revealAnswers() {
            if(!confirm("ç¢ºå®šè¦é¡¯ç¤ºæ‰€æœ‰ç­”æ¡ˆå—ï¼Ÿ")) return;
            
            let inputs = document.querySelectorAll('.cell input');
            inputs.forEach(input => {
                input.value = input.dataset.answer;
                input.classList.add('correct');
            });
        }

        // å•Ÿå‹•
        initGame();

    </script>
</body>
</html>